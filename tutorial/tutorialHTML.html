<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome file</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="grailsreact-offline-app-tutorial">Grails/React Offline App Tutorial</h1>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#backend">Backend</a></li>
<li><a href="#frontend">Frontend</a></li>
<li><a href="#offline-functionality">Offline Functionality</a></li>
</ul>
<p><a></a></p>
<h3 id="introduction">Introduction</h3>
<p>This tutorial is meant to be an introduction to React, specifically building react on top of a Grails backend. It assumes little to no React knowledge, and at least cursory knowledge of Grails.</p>
<p>We are going to be building a <a href="https://developers.google.com/web/progressive-web-apps/">progressive web app</a> that works even with no internet connection. It will be a simple fishing companion app that you would take on a fishing trip to document your catches.</p>
<p>The completed app can be found on Github <a href="https://github.com/2017-SD/fishing-tutorial-2">here</a></p>
<p>We will be covering the following:</p>
<ul>
<li>Building a grails app</li>
<li><a href="https://grails-plugins.github.io/grails-spring-security-core/snapshot/index.html">Spring Security</a></li>
<li>React components</li>
<li>Using <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">fetch</a> to talk to the app’s backend</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises</a></li>
<li><a href="https://developers.google.com/web/fundamentals/primers/service-workers/">ServiceWorkers</a> and <a href="https://github.com/localForage/localForage">Localforage</a></li>
</ul>
<p><a></a></p>
<h3 id="prerequisites">Prerequisites</h3>
<p>The first thing we are going to do is set up our development environment. Before we start, install Yarn and Node using your machine’s preferred package manager. Also, if you’re using Chrome, install React Developer Tools <a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi">here</a>. This is an extension allowing you to view your React application and all of its states and props, which helps with debugging.</p>
<p>In IntelliJ, set up a new Grails project. Under options, add the flag <code>—profile=react-webpack</code><br>
You can learn more about Grails profiles <a href="http://grails.org/profiles.html">here</a>. For our purposes, we are building a single React app that uses Grails as a backend.</p>
<p><img src="images/1.png" alt=""></p>
<p>After everything is initialized, go to <strong>build.gradle</strong> and find the ‘node’ option. Update the values for version and yarnVersion to reflect the current versions of yarn and node respectively. At the time of writing, they are v10.2.1 and 1.7.0, but you can run <code>node -v</code> and <code>yarn -v</code> to check.</p>
<p>The first run will take the longest to initialize everything, so let’s get this out of the way now, as well as make sure everything is in working order. We should be greeted with this page:</p>
<p><img src="images/2.png" alt=""></p>
<p>Next, we need to download some node modules that our app will depend on. In the terminal in Intellij, run the command <code>yarn add -D localforage</code>.<br>
The -D flag stands for ‘dev’, as these are developer dependencies. Refer back to list of things covered for more information on these packages.</p>
<p><a></a></p>
<h3 id="backend">Backend</h3>
<p>The basic idea of this app is that the user catches a fish in real life. The fisher then opens the app and fills out a form detailing the catch just landed. This form data gets saved into Grails as a ‘Catch’ that can then be looked up. The backend is going to be where we house our database and user authentication.</p>
<p>First, we are going to add Spring Security Core. This allows for us to authenticate users. Add this line to <strong>build.gradle</strong> at the end of the dependencies list after line 69.</p>
<pre class=" language-groovy"><code class="prism  language-groovy">dependencies <span class="token punctuation">{</span>
    compile <span class="token string gstring">"org.springframework.boot:spring-boot-starter-logging"</span>
    compile <span class="token string gstring">"org.springframework.boot:spring-boot-autoconfigure"</span>
    compile <span class="token string gstring">"org.grails:grails-core"</span>
    compile <span class="token string gstring">"org.springframework.boot:spring-boot-starter-actuator"</span>
    compile <span class="token string gstring">"org.springframework.boot:spring-boot-starter-tomcat"</span>
    compile <span class="token string gstring">"org.grails:grails-web-boot"</span>
    compile <span class="token string gstring">"org.grails:grails-logging"</span>
    compile <span class="token string gstring">"org.grails:grails-plugin-rest"</span>
    compile <span class="token string gstring">"org.grails:grails-plugin-databinding"</span>
    compile <span class="token string gstring">"org.grails:grails-plugin-i18n"</span>
    compile <span class="token string gstring">"org.grails:grails-plugin-services"</span>
    compile <span class="token string gstring">"org.grails:grails-plugin-url-mappings"</span>
    compile <span class="token string gstring">"org.grails:grails-plugin-interceptors"</span>
    compile <span class="token string gstring">"org.grails.plugins:cache"</span>
    compile <span class="token string gstring">"org.grails.plugins:async"</span>
    compile <span class="token string gstring">"org.grails.plugins:scaffolding"</span>
    compile <span class="token string gstring">"org.grails:grails-plugin-gsp"</span>
    compile <span class="token string gstring">"org.grails.plugins:events"</span>
    compile <span class="token string gstring">"org.grails.plugins:hibernate5"</span>
    compile <span class="token string gstring">"org.hibernate:hibernate-core:5.1.5.Final"</span>
    compile <span class="token string gstring">"org.grails.plugins:gsp"</span>
    compile <span class="token string gstring">"org.grails.plugins:views-json"</span>
    compile <span class="token string gstring">"org.grails.plugins:views-json-templates"</span>
    console <span class="token string gstring">"org.grails:grails-console"</span>
    profile <span class="token string gstring">"org.grails.profiles:react-webpack"</span>
    runtime <span class="token string gstring">"org.glassfish.web:el-impl:2.1.2-b03"</span>
    runtime <span class="token string gstring">"com.h2database:h2"</span>
    runtime <span class="token string gstring">"org.apache.tomcat:tomcat-jdbc"</span>
    runtime <span class="token string gstring">"com.bertramlabs.plugins:asset-pipeline-grails:2.14.8"</span>
    testCompile <span class="token string gstring">"org.grails:grails-gorm-testing-support"</span>
    testCompile <span class="token string gstring">"org.grails:grails-web-testing-support"</span>
    testCompile <span class="token string gstring">"org.grails.plugins:geb:1.1.2"</span>
    testRuntime <span class="token string gstring">"org.seleniumhq.selenium:selenium-chrome-driver:2.47.1"</span>
    testRuntime <span class="token string gstring">"org.seleniumhq.selenium:selenium-htmlunit-driver:2.47.1"</span>
    testRuntime <span class="token string gstring">"net.sourceforge.htmlunit:htmlunit:2.18"</span>
    <span class="token comment">// Adds Spring Security plugin</span>
    compile <span class="token string">'org.grails.plugins:spring-security-core:3.2.0'</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Next, open up the Grails command window under <strong>Tools &gt; Grails &gt; Run Grails Command</strong>.<br>
Run this command to set up Users and User Roles, making sure to replace ‘fishing_app’ with whatever you named your project. This guide will be referring to it as ‘fishing_app’.</p>
<p><img src="images/3.png" alt=""></p>
<p>Open up <em>/grails-app/conf/application.groovy</em>. At the bottom of the staticRules array, add these rules starting around line 18:</p>
<pre class=" language-groovy"><code class="prism  language-groovy"><span class="token punctuation">[</span>pattern<span class="token punctuation">:</span> <span class="token string">'/logout/**'</span><span class="token punctuation">,</span>      access<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'permitAll'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// for easy access to logout</span>
<span class="token punctuation">[</span>pattern<span class="token punctuation">:</span> <span class="token string">'/catch/**'</span><span class="token punctuation">,</span>       access<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'ROLE_USER'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// for catch controller</span>
<span class="token punctuation">[</span>pattern<span class="token punctuation">:</span> <span class="token string">'/sw.js'</span><span class="token punctuation">,</span>          access<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'permitAll'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string regex">//</span> <span class="token keyword">for</span> service worker
<span class="token punctuation">[</span>pattern<span class="token punctuation">:</span> <span class="token string">'/User/getLogin'</span><span class="token punctuation">,</span>  access<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'permitAll'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string regex">//</span> to check user login info
<span class="token punctuation">[</span>pattern<span class="token punctuation">:</span> <span class="token string">'/dbconsole/**'</span><span class="token punctuation">,</span>   access<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'ROLE_ADMIN'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// for access to H2 console</span>
</code></pre>
<p>These define what user roles can access what urls. Right now, they don’t exist, but they will in a minute. At the very bottom of the file, after the chainMap array, add the line:</p>
<pre class=" language-groovy"><code class="prism  language-groovy">grails<span class="token operator">.</span>plugin<span class="token operator">.</span>springsecurity<span class="token operator">.</span>logout<span class="token operator">.</span>postOnly <span class="token operator">=</span> <span class="token boolean">false</span>
</code></pre>
<p>This gives the user an easier time logging out by not requiring a POST request.</p>
<p>Next, go to <em>/grails-app/conf/application.yml</em>. In this file, we will be specifying some rules regarding uploading files. At the very top, add this resources line to the end of the block starting around line 11. This line <a href="https://gangmax.me/blog/2017/02/09/expose-static-resources-in-grails/">exposes static resouces</a> like .css and .js files to the browser.</p>
<pre class=" language-yml"><code class="prism  language-yml"><span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">'/**'</span>
</code></pre>
<p>This allows us to access external files as we need them. In the second grails: block, under controllers, add this block below the <code>defaultScope: singleton</code> declaration:</p>
<pre class=" language-yml"><code class="prism  language-yml">    <span class="token key atrule">upload</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxFileSize</span><span class="token punctuation">:</span> <span class="token number">262144000</span>
        <span class="token key atrule">maxRequestSize</span><span class="token punctuation">:</span> <span class="token number">262144000</span>
</code></pre>
<p>This allows us to upload normal sized images to Grails.</p>
<p>Now, back to the User domain we just created. In <em>/grails-app/domain/fishing_app/User</em> we are going to add a couple fields to personalize the User. Add a first and last name to the list of properties.</p>
<pre class=" language-groovy"><code class="prism  language-groovy">String username
String password
String fname 
String lname 
<span class="token keyword">boolean</span> enabled <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token keyword">boolean</span> accountExpired
<span class="token keyword">boolean</span> accountLocked
<span class="token keyword">boolean</span> passwordExpired
</code></pre>
<p>We are going to create a new domain now to represent the ‘Catch’ that was mentioned earlier. Create a new Grails Domain Class by right clicking the domain folder and selecting <strong>New &gt;</strong>. Call it Catch. Fill it out like this:</p>
<pre class=" language-groovy"><code class="prism  language-groovy"><span class="token keyword">package</span> fishing_app

<span class="token keyword">class</span> <span class="token class-name">Catch</span> <span class="token punctuation">{</span>
    String tripName
    String fishType
    String comment
    Float xCoord
    Float yCoord
    Date dateCaught
    String image

    <span class="token keyword">static</span> belongsTo <span class="token operator">=</span> <span class="token punctuation">[</span>user<span class="token punctuation">:</span> User<span class="token punctuation">]</span>

    <span class="token keyword">static</span> constraints <span class="token operator">=</span> <span class="token punctuation">{</span>
        tripName blank<span class="token punctuation">:</span> <span class="token boolean">false</span>
        fishType blank<span class="token punctuation">:</span> <span class="token boolean">false</span>
        comment nullable<span class="token punctuation">:</span> <span class="token boolean">true</span>
        xCoord nullable<span class="token punctuation">:</span> <span class="token boolean">true</span>
        yCoord nullable<span class="token punctuation">:</span> <span class="token boolean">true</span>
        dateCaught blank<span class="token punctuation">:</span> <span class="token boolean">false</span>
        image nullable<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>These fields are what the user is going to fill out in the form. Note that the constraints say that the tripName, fishType, and dateCaught cannot be blank. The other fields are optional.</p>
<p>These domains need controllers. The controllers are where we house the logic for the backend. The same way we made a new domain we can make new controllers. Make one for both Catch and User.</p>
<p>The User controller is simple. It will contain one function that checks whether or not we are logged in.</p>
<pre class=" language-groovy"><code class="prism  language-groovy"><span class="token keyword">package</span> fishing_app

<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token keyword">def</span> springSecurityService

    <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token comment">// this function checks if the user is logged in</span>
    <span class="token keyword">def</span> <span class="token function">getLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        User user <span class="token operator">=</span> springSecurityService<span class="token operator">.</span>currentUser

        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            render user<span class="token operator">.</span>fname
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            render <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The Catch controller has a couple of functions. The first function looks up all Catches made by the currently logged in User.</p>
<pre class=" language-groovy"><code class="prism  language-groovy"><span class="token keyword">import</span> grails<span class="token operator">.</span>converters<span class="token operator">.</span>JSON

<span class="token keyword">class</span> <span class="token class-name">CatchController</span> <span class="token punctuation">{</span>
    <span class="token keyword">def</span> springSecurityService

    <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">getCatches</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        User user <span class="token operator">=</span> springSecurityService<span class="token operator">.</span>currentUser
        render Catch<span class="token operator">.</span><span class="token function">findAllByUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> JSON
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Pay special attention to the name of the function. Remember this line that was added to <strong>application.groovy</strong>?</p>
<pre class=" language-groovy"><code class="prism  language-groovy"><span class="token punctuation">[</span>pattern<span class="token punctuation">:</span> <span class="token string">'/catch/**'</span><span class="token punctuation">,</span>       access<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'ROLE_USER'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// for catch controller</span>
</code></pre>
<p>The access key means that only users with the role <strong>ROLE_USER</strong> can access the catch controller, i.e. we have to be logged in. Similarly, the line</p>
<pre class=" language-groovy"><code class="prism  language-groovy"><span class="token punctuation">[</span>pattern<span class="token punctuation">:</span> <span class="token string">'/User/getLogin'</span><span class="token punctuation">,</span>   access<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'permitAll'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// to check user login info</span>
</code></pre>
<p>Refers to the getLogin function in the User controller. This line means anybody can call this function, logged in or not.</p>
<p>In the Catch controller, add another function called newCatch. It will contain the logic for converting the form data into a Catch object to save to Grails. It will look like this:</p>
<pre class=" language-groovy"><code class="prism  language-groovy"><span class="token comment">// Takes form parameters and saves it to the database</span>
<span class="token keyword">def</span> <span class="token function">newCatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    User user <span class="token operator">=</span> springSecurityService<span class="token operator">.</span>currentUser   <span class="token comment">// get current user</span>

    <span class="token keyword">def</span> tripName <span class="token operator">=</span> params<span class="token operator">.</span>tripName
    <span class="token keyword">def</span> fishType <span class="token operator">=</span> params<span class="token operator">.</span>fishType
    <span class="token keyword">def</span> dateCaught <span class="token operator">=</span> params<span class="token operator">.</span>dateCaught
    <span class="token keyword">def</span> xCoord <span class="token operator">=</span> params<span class="token operator">.</span>xCoord
    <span class="token keyword">def</span> yCoord <span class="token operator">=</span> params<span class="token operator">.</span>yCoord
    <span class="token keyword">def</span> comment <span class="token operator">=</span> params<span class="token operator">.</span>comment
    <span class="token keyword">def</span> image <span class="token operator">=</span> params<span class="token operator">.</span>image

    <span class="token keyword">def</span> dateCaughtModified <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string gstring">"yyyy-MM-dd"</span><span class="token punctuation">,</span> dateCaught<span class="token punctuation">)</span>

    <span class="token keyword">def</span> destFilename
    <span class="token keyword">def</span> imageUpload <span class="token operator">=</span> image
    <span class="token keyword">def</span> img_path <span class="token operator">=</span> <span class="token string gstring">"/Desktop/directed_study/code/building/grails/fishing_app/src/main/webapp/images/uploaded"</span>

    <span class="token comment">// if image was passed else make it null (queue sends null parameter as string)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>imageUpload <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> imageUpload <span class="token operator">!=</span> <span class="token string gstring">"null"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">def</span> destDir <span class="token operator">=</span> System<span class="token operator">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string gstring">"user.home"</span><span class="token punctuation">)</span> <span class="token operator">+</span> img_path

        <span class="token keyword">def</span> id <span class="token operator">=</span> UUID<span class="token operator">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>Catch<span class="token operator">.</span><span class="token function">countByImage</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// if this photo name already exist make a new one</span>
            id <span class="token operator">=</span> UUID<span class="token operator">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>


        destFilename <span class="token operator">=</span> String<span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string gstring">"%s.jpg"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
        File destFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>destDir<span class="token punctuation">,</span> destFilename<span class="token punctuation">)</span>

        destFile<span class="token operator">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        imageUpload<span class="token operator">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>destFile<span class="token punctuation">)</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        destFilename <span class="token operator">=</span> null
    <span class="token punctuation">}</span>

    <span class="token keyword">def</span> fishCatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catch</span><span class="token punctuation">(</span>
            user<span class="token punctuation">:</span> user<span class="token punctuation">,</span>
            tripName<span class="token punctuation">:</span> tripName<span class="token punctuation">,</span>
            fishType<span class="token punctuation">:</span> fishType<span class="token punctuation">,</span>
            dateCaught<span class="token punctuation">:</span> dateCaughtModified<span class="token punctuation">,</span>
            xCoord<span class="token punctuation">:</span> xCoord<span class="token punctuation">,</span>
            yCoord<span class="token punctuation">:</span> yCoord<span class="token punctuation">,</span>
            comment<span class="token punctuation">:</span> comment<span class="token punctuation">,</span>
            image<span class="token punctuation">:</span> destFilename<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    fishCatch<span class="token operator">.</span><span class="token function">save</span><span class="token punctuation">(</span>flush<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> failOnError<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    render <span class="token string gstring">"Success!"</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>NOTE: MAKE SURE YOU UPDATE img_path TO REFLECT WHERE YOUR PROJECT IS LOCATED.</strong></p>
<p>Make a new directory in <em>/src/main/webapp/images/</em> called ‘uploaded’. This will be where all our uploaded images get stored. To be sure img_path is correct, just copy the absolute path of the newly created directory &amp; use that as the value.</p>
<p>Finally, we will create some test data to make sure everything is in working order. In<br>
<em>/grails-app/init/fishing_app/BootStrap</em> add the following. The values can be replaced however you want, and additional catches can be added.</p>
<pre class=" language-groovy"><code class="prism  language-groovy"><span class="token keyword">class</span> <span class="token class-name">BootStrap</span> <span class="token punctuation">{</span>

    <span class="token keyword">def</span> init <span class="token operator">=</span> <span class="token punctuation">{</span> servletContext <span class="token operator">-&gt;</span>

        <span class="token keyword">def</span> today <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// Add for creating Roles and Users</span>
        <span class="token comment">// def adminRole = new Role(authority: 'ROLE_ADMIN').save(flush: true)</span>
        <span class="token keyword">def</span> userRole <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Role</span><span class="token punctuation">(</span>authority<span class="token punctuation">:</span> <span class="token string">'ROLE_USER'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">save</span><span class="token punctuation">(</span>flush<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

        <span class="token comment">// Create the account and save it</span>
        <span class="token keyword">def</span> testUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>username<span class="token punctuation">:</span> <span class="token string">'b'</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span> fname<span class="token punctuation">:</span> <span class="token string">'Bryce'</span><span class="token punctuation">,</span> lname<span class="token punctuation">:</span> <span class="token string">'Williams'</span><span class="token punctuation">)</span>

        testUser<span class="token operator">.</span><span class="token function">save</span><span class="token punctuation">(</span>flush<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

        UserRole<span class="token operator">.</span>create testUser<span class="token punctuation">,</span> userRole<span class="token punctuation">,</span> <span class="token boolean">true</span>
        UserRole<span class="token operator">.</span>withSession <span class="token punctuation">{</span>
            it<span class="token operator">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            it<span class="token operator">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Create a fish and save it</span>
        <span class="token keyword">def</span> fish <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catch</span><span class="token punctuation">(</span>
                tripName<span class="token punctuation">:</span> <span class="token string gstring">"Up State"</span><span class="token punctuation">,</span>
                fishType<span class="token punctuation">:</span> <span class="token string gstring">"Walleye"</span><span class="token punctuation">,</span>
                comment<span class="token punctuation">:</span> <span class="token string gstring">"It was cold"</span><span class="token punctuation">,</span>
                dateCaught<span class="token punctuation">:</span> today<span class="token punctuation">,</span>
                xCoord<span class="token punctuation">:</span> <span class="token number">47.1211</span><span class="token punctuation">,</span>
                yCoord<span class="token punctuation">:</span> <span class="token number">88.5694</span><span class="token punctuation">,</span>
                image<span class="token punctuation">:</span> <span class="token string gstring">"later.png"</span><span class="token punctuation">,</span>
                user<span class="token punctuation">:</span> testUser
        <span class="token punctuation">)</span>

        fish<span class="token operator">.</span><span class="token function">save</span><span class="token punctuation">(</span>flush<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span>


    <span class="token keyword">def</span> destroy <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>A couple things to point out:</p>
<ul>
<li>adminRole is used for administrative purposes. You can give special permissions to different roles.</li>
<li>The value for the image in the catch is just a placeholder. It does not actually refer to anything.</li>
</ul>
<p>Now, when we re-run the app, we are greeted with the same startup page. However, controller functions can be referenced as URLs. For example, let’s test the getLogin() function in the User controller. In the browser, add <em>/user/getLogin</em> to the end of the url. We should be greeted with this page:</p>
<p><img src="images/4.png" alt=""></p>
<p>It renders false, because we aren’t logged in. Try navigating to the <code>getCatches()</code> function in the catch controller. It’s secured, so we shouldn’t be able to, right? <em>/catch/getCatches</em> will redirect us to the log in page, thanks to Spring Security.</p>
<p><img src="images/5.png" alt=""></p>
<p>Log in with the bootstrapped account, and we will be redirected to the correct page</p>
<p><img src="images/6.png" alt=""></p>
<p>Now, go back to the <em>/user/getLogin</em> page. It should now show us who we’re logged in as.</p>
<p><img src="images/7.png" alt=""></p>
<p>That’s it for the backend. Now we have a foundation for the frontend which we will be building in React.</p>
<p><a></a></p>
<h3 id="frontend">Frontend</h3>
<p>Recall the fishing scenario from earlier. The frontend is going to contain the form and all of the rest of the user interactions.</p>
<p>Open <em>/src/main/webapp/App.js</em>. This is where we are going to build the frontend. If you study the code in the <code>render() { }</code> block, you’ll notice that this is what is being displayed when we run the app. It may look daunting at first, but React is simpler than it seems.</p>
<p>First, we are going to replace the Navbar with our own. We will start by replacing the App.js file with the below:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-bootstrap'</span><span class="token punctuation">;</span>

<span class="token comment">/** components */</span>
<span class="token keyword">import</span> AppNav <span class="token keyword">from</span> <span class="token string">'./AppNav'</span>

<span class="token keyword">import</span> <span class="token string">'whatwg-fetch'</span><span class="token punctuation">;</span>


<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            online<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            logged_in<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>
            online<span class="token punctuation">,</span>
            logged_in<span class="token punctuation">,</span>
        <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state

        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>AppNav
                    logged_in<span class="token operator">=</span><span class="token punctuation">{</span>logged_in<span class="token punctuation">}</span>
                    online<span class="token operator">=</span><span class="token punctuation">{</span>online<span class="token punctuation">}</span>
                <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>
</code></pre>
<p>App.js is what is known as a <a href="https://reactjs.org/docs/react-component.html">React Component</a>. Look at the reference for more details. The basic idea is that components can be defined as classes or functions. Components defined as classes have the constructor block and usually defines a <a href="https://reactjs.org/docs/state-and-lifecycle.html">state</a>. The state of a component can be thought of as a list of global variables that are immutable. If the app changes state, it must re-render to reflect those changes.</p>
<p>The block starting around line 10 is the constructor. The call to <code>super()</code> initializes the constructor so that the component can use the <code>this</code> keyword. The next line defines the state of the app. It defines two booleans: <code>online</code> and <code>logged_in</code>. <code>online</code> is going to indicate whether or not the user is online, and <code>logged_in</code>, whether or not the user is logged in.</p>
<p>Every component must have a <code>render() { }</code> block. The html-esque tags in the return statement are converted to html and get displayed in the browser. Before the return statement, additional logic that controls what gets rendered can be placed here. Lines 22-25 is a shorthand way of referencing state variables. Without this, online and logged_in must be referenced using <code>this.state.online</code> and <code>this.state.logged_in</code>. Finally, the tag around line 29 is our Navbar. Lines 30 and 31 are called props. These are parameter variables passed to a component in the same way a function is called with arguments. We will touch on this more in a second.</p>
<p>Navigate to AppNav.js. Replace the contents with the following:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Navbar<span class="token punctuation">,</span> Nav<span class="token punctuation">,</span> NavItem <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-bootstrap'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> nav_styles <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/Styles'</span>

<span class="token keyword">import</span> <span class="token string">'whatwg-fetch'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">AppNav</span> <span class="token operator">=</span> props <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        logged_in<span class="token punctuation">,</span>
        online
    <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>


    <span class="token comment">// conditionally renders login/logout link</span>
    <span class="token keyword">const</span> <span class="token function-variable function">nav</span> <span class="token operator">=</span> <span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>Navbar style<span class="token operator">=</span><span class="token punctuation">{</span>nav_styles<span class="token punctuation">.</span>nav<span class="token punctuation">}</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Nav style<span class="token operator">=</span><span class="token punctuation">{</span>nav_styles<span class="token punctuation">.</span>item<span class="token punctuation">}</span> pullLeft<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>NavItem href<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'/'</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
                        The Fishing App
                    <span class="token operator">&lt;</span><span class="token operator">/</span>NavItem<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>Nav<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>Nav style<span class="token operator">=</span><span class="token punctuation">{</span>nav_styles<span class="token punctuation">.</span>item_right<span class="token punctuation">}</span> pullRight<span class="token operator">&gt;</span>
                    <span class="token punctuation">{</span> <span class="token comment">/* only show login/logout button if online */</span>
                        online <span class="token operator">&amp;&amp;</span>
                        link
                    <span class="token punctuation">}</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>Nav<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Navbar<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">const</span> login <span class="token operator">=</span> <span class="token operator">&lt;</span>NavItem href<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'/login/auth'</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>Log In<span class="token operator">&lt;</span><span class="token operator">/</span>NavItem<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> logout <span class="token operator">=</span> <span class="token operator">&lt;</span>NavItem href<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'/logout'</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>Log Out<span class="token operator">&lt;</span><span class="token operator">/</span>NavItem<span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>logged_in<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">nav</span><span class="token punctuation">(</span>logout<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token function">nav</span><span class="token punctuation">(</span>login<span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">export</span> <span class="token keyword">default</span> AppNav<span class="token punctuation">;</span>
</code></pre>
<p>AppNav is a component that is defined as a function rather than a class. These are also known as <a href="https://hackernoon.com/react-stateless-functional-components-nine-wins-you-might-have-overlooked-997b0d933dbc">stateless</a> functional or dumb components. They do not have as much overhead as a stateful component, and are meant to inherit state from their parent as properties.</p>
<p>Before we do anything, there is some styling we need to add. The import around line 4 will be throwing an error, because that file does not exist yet. In the <em>/src/</em> folder, make a directory called <em>util</em>. This is where we will be keeping extra JavaScript files that are not components. Make a JavaScript file called Styles, and fill it out like below. Then, navigate to <em>/src/main/webapp/css/App.css</em> and comment everything out.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** APP */</span>
<span class="token keyword">const</span> button <span class="token operator">=</span> <span class="token punctuation">{</span>
    margin<span class="token punctuation">:</span> <span class="token string">"5px"</span><span class="token punctuation">,</span>
    display<span class="token punctuation">:</span> <span class="token string">"flex"</span><span class="token punctuation">,</span>
    justifyContent<span class="token punctuation">:</span> <span class="token string">"center"</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> app_styles <span class="token operator">=</span> <span class="token punctuation">{</span>
    button<span class="token punctuation">:</span> button
<span class="token punctuation">}</span>


<span class="token comment">/** NAVBAR */</span>
<span class="token keyword">const</span> nav <span class="token operator">=</span> <span class="token punctuation">{</span>
    backgroundColor<span class="token punctuation">:</span> <span class="token string">"#73b566"</span><span class="token punctuation">,</span>
    backgroundImage<span class="token punctuation">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>
    marginBottom<span class="token punctuation">:</span> <span class="token string">"15px"</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> item <span class="token operator">=</span> <span class="token punctuation">{</span>
    display<span class="token punctuation">:</span> <span class="token string">"inline-block"</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> item_right <span class="token operator">=</span> <span class="token punctuation">{</span>
    display<span class="token punctuation">:</span> <span class="token string">"inline-block"</span><span class="token punctuation">,</span>
    float<span class="token punctuation">:</span> <span class="token string">"right"</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> nav_styles <span class="token operator">=</span> <span class="token punctuation">{</span>
    nav<span class="token punctuation">:</span> nav<span class="token punctuation">,</span>
    item<span class="token punctuation">:</span> item<span class="token punctuation">,</span>
    item_right<span class="token punctuation">:</span> item_right
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> app_styles<span class="token punctuation">,</span> nav_styles <span class="token punctuation">}</span>
</code></pre>
<p>In React, styles are declared like objects. The css properties still have the same name, except that the ones that are words separated by a dash become camelCase (<code>background-color</code> becomes <code>backgroundColor</code>). You can add styling like this, but it can be added inline as well. Check <a href="https://codeburst.io/4-four-ways-to-style-react-components-ac6f323da822">this</a> article out to see more ways to style your components.</p>
<p>Now, back to AppNav. The first thing you may notice is the strange declaration of the function around line 8. This is called an <a href="https://codeburst.io/javascript-arrow-functions-for-beginners-926947fc0cdc">arrow-function</a>. The key differences between a regularly declared function and an arrow function are that arrow functions are written in a cleaner syntax, and they do not bind the keyword <code>this</code>. What that means is that any arrow function that references <code>this</code> references the original binding, and doesn’t try to look for something inside the function. This will be expanded on more as we go through the guide. Check the arrow-function link for a more in-depth explanation.</p>
<p>Lines 9-12 are a cleaner way to declare the props that are being passed to the component. They can be listed as separate parameters like so:<br>
<code>const AppNav = ({logged_in, online}) =&gt; {…}</code><br>
and would change nothing about the functionality.</p>
<p>Line 16-33 is the navbar itself. It is being built as a function because it contains the login/logout button. Which button gets displayed depends on the <code>logged_in</code> prop. This is called <a href="https://reactjs.org/docs/conditional-rendering.html">conditional rendering</a>. The link that gets passed as a parameter is going to be one of the NavItems declared on lines 36 and 37. Furthermore, we only want to display this link if the app is online, since logging in or out requires an internet connection. The block around line 26-29 is how we achieve this. It is similar to the logical <code>and</code> in other programming languages, the idea being that if the first half is true, then it will look at the second half, and skip over it otherwise.</p>
<p>Finally, the line at the very bottom tells React to export the function so that it can be imported in another file.</p>
<p>Now, re-run the app. Our app should now look like this:</p>
<p><img src="images/8.png" alt=""></p>
<p>Now, try logging in. It works as expected, but now we can’t log out. This is because we never update the <code>logged_in</code> state. Back in App.js add this underneath the constructor:</p>
<pre class=" language-js"><code class="prism  language-js"> <span class="token comment">/** checks for online &amp; logged in status */</span>
<span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// check if online</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>online<span class="token punctuation">:</span> navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// check if logged in</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">"/user/getLogin"</span><span class="token punctuation">;</span>

    <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
        credentials<span class="token punctuation">:</span> <span class="token string">'same-origin'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>text <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">===</span> <span class="token string">'false'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>logged_in<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>logged_in<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>componentWillMount</code> is what’s called a <a href="https://reactjs.org/docs/react-component.html">lifecycle function</a>. They are used to update a component during a specific phase of its lifecycle. In this case, we want to check the app’s logged in status as it’s mounting so that it will be ready upon first use.</p>
<p>The very first thing it does is checks if the app is online. navigator.onLine is a JavaScript property that lets us know if there is a connection or not, so we will set our online state to reflect it. Then, if we are online, we can <code>fetch</code> the logged in status from Grails. <a href="https://developers.google.com/web/updates/2015/03/introduction-to-fetch">Fetch</a> is similar to ajax, but it is built on <a href="https://developers.google.com/web/fundamentals/primers/promises">Promises</a>, which is a more simplified way of doing asynchronous tasks than callbacks. We will expound upon how to build our own Promises later. Building the request is simple: the call is <code>fetch(url, {options})</code>. The url is the same as what we manually navigated to earlier. The options we specify will be <code>method</code> and <code>credentials</code> Our method is <code>‘GET’</code> because we are retrieving information, and we set the credentials to <code>‘same-origin’</code>.<br>
A promise is a function that does an operation, and returns one of two functions depending on the results. If the operation succeeds, it will <code>resolve()</code>, otherwise it will <code>reject()</code>. These correspond to <code>.then()</code> and <code>.catch()</code> respectively. In our example, when fetch is called, it’s really calling the <code>getLogin</code> function in the user controller, and passing the result to <code>resolve()</code>. On line 33, <code>.then()</code> is how we retrieve the response which is what the variable <code>r</code> is. All responses from fetch come back as objects, but they can be transformed if need be. For this use, we just want the text, so we will be calling the <code>text()</code> function on the response. This returns another Promise, so we will need to use <code>.then()</code> one more time to get the text. This is called chaining promises, which can be done as many times as necessary. Doing the same thing with callbacks is possible, but infinitely more messy and harder to follow. Inside this promise resolution, we can set the <code>logged_in</code> state to reflect what Grails sees.</p>
<p>Re-run the app, and now the login button updates like it’s supposed to!</p>
<p>One last thing before we move on: Due to the nature of the app’s usage, we cannot assume the user’s internet connection will be stable. If the app thinks the user is online after they have lost connection, problems could arise. We want the app to check its online status whenever possible. Under the <code>componentWillMount()</code> function add this lifecycle function:</p>
<pre class=" language-js"><code class="prism  language-js"> <span class="token comment">/** updates the online status */</span>
<span class="token function">componentWillUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if online status was changed</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> online <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state

    <span class="token keyword">if</span> <span class="token punctuation">(</span>online <span class="token operator">!==</span> navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>online<span class="token punctuation">:</span> navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This function gets called every time the component updates, like during a state change or a rendering of another component. It simply checks the online property against its own online state, and sets the state to match the property if it changed.</p>
<p>Next, we are going to add a feature to display the catches we landed, i.e. getCatches. Functionally, it will work like this: if the user is online and logged in a request can be made to Grails from React to retrieve the catches. This means we will need to keep track of the catches somehow. We would also like to be able to view the details of each catch. The workflow then is to make a fetch request to Grails, and store the catches in a table to be viewed. We will start by adding a couple more things to the state. In the <em>App.js</em> constructor, add these to the state:</p>
<pre class=" language-js"><code class="prism  language-js">posted_catches<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment">// catches in the database</span>

showing_detail_modal<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token comment">// catch detail modal</span>
display_catch<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token comment">// catch info to display</span>

showing_loading_modal<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>   <span class="token comment">// modal indicating something is loading</span>
loading_message<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>            <span class="token comment">// message to display on the modal</span>
</code></pre>
<p>The states are as follows:</p>
<ul>
<li><code>posted_catches</code> - an array of catches retrieved from Grails</li>
<li><code>showing_detail_modal</code> - a boolean that indicates whether or not the detail modal is being displayed. The detail modal is going to be a modal that displays the information of the catch that has been selected.</li>
<li><code>display_catch</code> - the catch that will be displayed in the above modal.</li>
<li><code>showing_loading_modal</code> - a boolean indicating whether or not the loading modal is being displayed. The loading modal will be a simple modal that shows when an asynchronous task like a fetch is being done. Its purpose is to let the user know that the app is actually doing work and silently failing. The modal disappears automatically when the task is done.</li>
<li><code>loading_message</code> - the message to be displayed on the loading modal. This message will tell the user which async task is being performed.</li>
</ul>
<p>Being that we will be working with arrays quite a bit, it would be useful to have a helper function to check whether or not an array is empty. In the <em>util</em> folder, make a JavaScript file called <code>ArrayFunc</code>. You can go ahead and put functions in here that will make your array operations easier, but the main function we will be using in this app is this one:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>array <span class="token operator">===</span> undefined <span class="token operator">||</span> array <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> array<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Update the imports in App.js to include this, as well as the following:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-bootstrap'</span><span class="token punctuation">;</span>

<span class="token comment">/** components */</span>
<span class="token keyword">import</span> AppNav <span class="token keyword">from</span> <span class="token string">'./AppNav'</span>

<span class="token keyword">import</span> CatchTable <span class="token keyword">from</span> <span class="token string">'./components/CatchTable'</span>
<span class="token keyword">import</span> CatchDetailModal <span class="token keyword">from</span> <span class="token string">'./components/modals/CatchDetailModal'</span>
<span class="token keyword">import</span> LoadingModal <span class="token keyword">from</span> <span class="token string">'./components/modals/LoadingModal'</span>

<span class="token comment">/** helper stuff */</span>
<span class="token keyword">import</span> isEmpty <span class="token keyword">from</span> <span class="token string">'./util/ArrayFunc'</span>

<span class="token comment">/** styling */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> app_styles <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/Styles'</span>

<span class="token keyword">import</span> <span class="token string">'whatwg-fetch'</span><span class="token punctuation">;</span>
</code></pre>
<p>Lines 7-9 are going to be the components we need next. In <em>/src/webapp/</em> make a directory called components. This will house all our additional components. Inside the <em>/components/</em> directory, make another directory called <em>modals</em>. We will be keeping our various modals here. Before we continue building out the app, let’s make these components.</p>
<p>The catch table will be where all of our catches get displayed. In components, make a JavaScript file called <code>CatchTable</code>.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Table <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-bootstrap'</span>

<span class="token keyword">import</span> isEmpty <span class="token keyword">from</span> <span class="token string">'../util/ArrayFunc'</span>

<span class="token keyword">const</span> <span class="token function-variable function">CatchTable</span> <span class="token operator">=</span> props <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        catches<span class="token punctuation">,</span>
        showDetailModal
    <span class="token punctuation">}</span> <span class="token operator">=</span> props

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>catches<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>Table responsive<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>thead<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>tr<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Catch<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Type <span class="token keyword">of</span> fish<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Date<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>thead<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Table<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token function-variable function">table</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> rows <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">in</span> catches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> c <span class="token operator">=</span> catches<span class="token punctuation">[</span>item<span class="token punctuation">]</span>
            <span class="token keyword">let</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>dateCaught<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
                <span class="token operator">&lt;</span>tr key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">showDetailModal</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>tripName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>fishType<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token punctuation">{</span>date<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Table responsive<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>thead<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>tr<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Catch<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Type <span class="token keyword">of</span> fish<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Date<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>thead<span class="token operator">&gt;</span>

                    <span class="token operator">&lt;</span>tbody<span class="token operator">&gt;</span>
                        <span class="token punctuation">{</span>rows<span class="token punctuation">}</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>tbody<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>Table<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> CatchTable<span class="token punctuation">;</span>
</code></pre>
<p>The component’s props are going to be catches, which is the posted_catches state variable from the App, and showDetailModal, which is going to be the showing_detail_modal state variable. The first thing the component will do is check if there are any catches at all. If there are not, it just returns an empty table. Otherwise it calls the <code>table()</code> function</p>
<p>The <code>table</code> function dynamically builds each row, one for each catch. The columns are going to be the tripName, fishType, and dateCaught. Each row has an onClick function that allows the user to view the full details of the catch associated with the row being clicked by passing the catch to the detail modal. Notice how the onClick function is defined as an arrow function. If we define the onClick as <code>onClick={showDetailModal(c)}</code> it actually calls the function upon render, not when it’s clicked. The difference is that the arrow function gives us the function <em>itself</em>, and the other definition gives us what the function <em>returns</em>. Also don’t worry about the undeclared property warning for the properties of the Catches. IntelliJ does not know what they are, but Grails does and React will.</p>
<p>Next, we will build the catch detail modal. In <em>/webapp/components/modals/</em> make a JavaScript file called <code>CatchDetailModal</code>.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Modal<span class="token punctuation">,</span> Image <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-bootstrap'</span>


<span class="token keyword">const</span> <span class="token function-variable function">CatchDetailModal</span> <span class="token operator">=</span> props <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        showing<span class="token punctuation">,</span>
        hideModal<span class="token punctuation">,</span>
        selected_catch
    <span class="token punctuation">}</span> <span class="token operator">=</span> props

    <span class="token keyword">let</span> img_attached <span class="token operator">=</span> <span class="token punctuation">(</span>selected_catch<span class="token punctuation">.</span>image <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> img <span class="token operator">=</span> img_attached <span class="token operator">?</span> <span class="token template-string"><span class="token string">`../images/uploaded/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>selected_catch<span class="token punctuation">.</span>image<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">:</span> <span class="token string">''</span>

    <span class="token keyword">let</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>selected_catch<span class="token punctuation">.</span>dateCaught<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>Modal show<span class="token operator">=</span><span class="token punctuation">{</span>showing<span class="token punctuation">}</span> onHide<span class="token operator">=</span><span class="token punctuation">{</span>hideModal<span class="token punctuation">}</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Modal<span class="token punctuation">.</span>Header closeButton<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Modal<span class="token punctuation">.</span>Title<span class="token operator">&gt;</span><span class="token punctuation">{</span>selected_catch<span class="token punctuation">.</span>tripName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token punctuation">.</span>Title<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token punctuation">.</span>Header<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Modal<span class="token punctuation">.</span>Body<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>b<span class="token operator">&gt;</span>Date<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">/</span>b<span class="token operator">&gt;</span><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span>date<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>b<span class="token operator">&gt;</span>Fish type<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">/</span>b<span class="token operator">&gt;</span><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span>selected_catch<span class="token punctuation">.</span>fishType<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>b<span class="token operator">&gt;</span>Comments<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">/</span>b<span class="token operator">&gt;</span><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span>selected_catch<span class="token punctuation">.</span>comment<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>b<span class="token operator">&gt;</span>Location<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">/</span>b<span class="token operator">&gt;</span><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span>selected_catch<span class="token punctuation">.</span>xCoord<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>selected_catch<span class="token punctuation">.</span>yCoord<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token punctuation">{</span> <span class="token comment">/* only displays if there is an image */</span>
                    img_attached <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>width<span class="token punctuation">:</span> <span class="token number">250</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token string">'auto'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>Image src<span class="token operator">=</span><span class="token punctuation">{</span>img<span class="token punctuation">}</span> responsive<span class="token operator">/</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token punctuation">.</span>Body<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> CatchDetailModal<span class="token punctuation">;</span>
</code></pre>
<p>Modals in React are fairly simple. They have two properties: <code>show</code> and <code>onHide</code>. <code>show</code> takes a boolean which is usually set with a state variable. <code>true</code> means the modal is being displayed, and <code>false</code> means it is being hidden. <code>onHide</code> is what happens when the modal is to be hidden. In most cases, it is a function that sets the show variable to false. For the catch detail modal, <code>show</code> is going to be the <code>showing_detail_modal</code> state variable, and <code>onHide</code> is going to be a function in App.js passed as a prop that hides the modal. The modal will take one more prop: the catch from the table that was clicked. The contents of the modal will be the details of the catch, with some conditional rendering to handle if the user uploaded an image. Line 14 grabs the appropriate image from the <em>/webapp/images/uploaded/</em> folder that was created earlier.</p>
<p>Finally, we will build the loading modal.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Modal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-bootstrap'</span>

<span class="token keyword">import</span> spinner <span class="token keyword">from</span> <span class="token string">'../../images/spinner.gif'</span>

<span class="token keyword">const</span> <span class="token function-variable function">LoadingModal</span> <span class="token operator">=</span> props <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        showing<span class="token punctuation">,</span>
        hideModal<span class="token punctuation">,</span>
        message
    <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>Modal show<span class="token operator">=</span><span class="token punctuation">{</span>showing<span class="token punctuation">}</span> onHide<span class="token operator">=</span><span class="token punctuation">{</span>hideModal<span class="token punctuation">}</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Modal<span class="token punctuation">.</span>Header closeButton<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Modal<span class="token punctuation">.</span>Title<span class="token operator">&gt;</span><span class="token punctuation">{</span>message<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token punctuation">.</span>Title<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token punctuation">.</span>Header<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Modal<span class="token punctuation">.</span>Body<span class="token operator">&gt;</span>
                <span class="token punctuation">{</span>spinner<span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token punctuation">.</span>Body<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> LoadingModal
</code></pre>
<p>This modal will have the same props, except replacing the catch prop with a loading message. The spinner in the modal body has already been provided to us by Grails; there is no need to download one. This is also how images get imported for use in React; just treat it like any other file.</p>
<p>Finally, lets go back to App.js. Time to put it all together. Underneath the <code>componentWillUpdate()</code> function, let’s add our modal functions.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** opens the loading modal */</span>
<span class="token function-variable function">showLoadingModal</span> <span class="token operator">=</span> m <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        loading_message<span class="token punctuation">:</span> m<span class="token punctuation">,</span>
        showing_loading_modal<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/** closes the loading modal */</span>
<span class="token function-variable function">hideLoadingModal</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        showing_loading_modal<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        loading_message<span class="token punctuation">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/** opens the detail modal */</span>
<span class="token function-variable function">showDetailModal</span> <span class="token operator">=</span> c <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        display_catch<span class="token punctuation">:</span> c<span class="token punctuation">,</span>
        showing_detail_modal<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/** closes the detail modal */</span>
<span class="token function-variable function">hideDetailModal</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        showing_detail_modal<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        display_catch<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The show functions take a parameter to pass to their respective modals. The parameter gets set as the value of its respective state variable, and when the modals are hidden, those state variables get cleared for reuse.</p>
<p>Under these functions we will add one more function to get the catches from Grails</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** shows catches that have been uploaded */</span>
<span class="token function-variable function">showCatches</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showLoadingModal</span><span class="token punctuation">(</span><span class="token string">'RETRIEVING CATCHES...'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">"/catch/getCatches"</span><span class="token punctuation">;</span>

    <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
        credentials<span class="token punctuation">:</span> <span class="token string">'same-origin'</span><span class="token punctuation">,</span>     <span class="token comment">// Need credentials so that the JSESSIONID cookie is sent</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>catches <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>catches<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> fish <span class="token keyword">in</span> catches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>catches<span class="token punctuation">[</span>fish<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>posted_catches<span class="token punctuation">:</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span>

                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hideLoadingModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"App.ShowCatches"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This function is going to be making a fetch request, which means that we will have to use the loading modal to show the user that something is happening. The url this time is<br>
<em>/catch/getCatches/</em> same as the one we manually used earlier. Since the catches in Grails get returned as JSON, we will use the <code>json()</code> function for the fetch response so that we can view the properties of the Catch. The correct way to update an array as a state variable in React is to treat it as if it was immutable. Create a new array that is either empty or the same as the state variable array, depending on what you are trying to do, and perform the operations on that. Then, set that array as the new state variable.</p>
<p>Finally, we will update the render function. Now that we have more state variables, they need to be added to the <code>const</code> block to be more easily referenced, as well as the components we just made.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        online<span class="token punctuation">,</span>
        logged_in<span class="token punctuation">,</span>

        posted_catches<span class="token punctuation">,</span>

        showing_detail_modal<span class="token punctuation">,</span>
        display_catch<span class="token punctuation">,</span>

        showing_loading_modal<span class="token punctuation">,</span>
        loading_message<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state


    <span class="token comment">// all items true if not empty</span>
    <span class="token keyword">let</span> catches             <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>posted_catches<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// for posted catches</span>
    <span class="token keyword">let</span> catch_to_display    <span class="token operator">=</span> <span class="token punctuation">(</span>display_catch <span class="token operator">!==</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token comment">// for catch detail modal</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>AppNav
                logged_in<span class="token operator">=</span><span class="token punctuation">{</span>logged_in<span class="token punctuation">}</span>
                online<span class="token operator">=</span><span class="token punctuation">{</span>online<span class="token punctuation">}</span>
            <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>

            <span class="token punctuation">{</span> <span class="token comment">/* only show catches if online &amp; logged in */</span>
                online <span class="token operator">&amp;&amp;</span> logged_in <span class="token operator">&amp;&amp;</span>
                <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span>app_styles<span class="token punctuation">.</span>button<span class="token punctuation">}</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>showCatches<span class="token punctuation">}</span> bsStyle<span class="token operator">=</span><span class="token string">"success"</span><span class="token operator">&gt;</span>Show Your Catches<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">{</span> <span class="token comment">/* only show if there have been catches posted */</span>
                catches <span class="token operator">&amp;&amp;</span>
                <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>CatchTable
                        catches<span class="token operator">=</span><span class="token punctuation">{</span>posted_catches<span class="token punctuation">}</span>
                        showDetailModal<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>showDetailModal<span class="token punctuation">}</span>
                    <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">{</span><span class="token comment">/* modals */</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span>LoadingModal
                showing<span class="token operator">=</span><span class="token punctuation">{</span>showing_loading_modal<span class="token punctuation">}</span>
                hideModal<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>hideLoadingModal<span class="token punctuation">}</span>
                message<span class="token operator">=</span><span class="token punctuation">{</span>loading_message<span class="token punctuation">}</span>
            <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token punctuation">{</span>
                catch_to_display <span class="token operator">&amp;&amp;</span>
                <span class="token operator">&lt;</span>CatchDetailModal
                    showing<span class="token operator">=</span><span class="token punctuation">{</span>showing_detail_modal<span class="token punctuation">}</span>
                    hideModal<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>hideDetailModal<span class="token punctuation">}</span>
                    selected_catch<span class="token operator">=</span><span class="token punctuation">{</span>display_catch<span class="token punctuation">}</span>
                <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The lines at 154 and 155 are conditions for conditionally rendering the Catch table and Catch detail modal respectively. They must be conditionally rendered so that the app does not crash trying to do operations on empty or undefined objects.</p>
<p>The button on line 167 has the <code>showCatches</code> function we made earlier as its <code>onClick</code> function. After the function completes its run, the <code>catches</code> boolean from line 154 becomes true, which allows the Catch table to be rendered. Since the fetch requires you to be online and logged in to get a proper response, we should only allow it to be rendered if those requirements are met.</p>
<p>Notice the functions being passed as props to the Catch table, loading modal, and Catch detail modal. These are the functions being referenced as props inside of the components when we defined them earlier, and defined here rather than inside the components themselves.</p>
<p>Run the app again. Initially, it looks exactly the same. Log in, and the <code>showCatches</code> button appears. Click on it, and the table appears with the catch that was Bootstrapped into the database</p>
<p><img src="images/9.png" alt=""></p>
<p>Click on the row in the table, and the modal with the Catch details appears.</p>
<p><img src="images/10.png" alt=""></p>
<p>The next step is to use what we learned to create a new catch and save it to Grails. Recall that this part is supposed to work regardless of an internet connection. We will set this up now.</p>
<p><a></a></p>
<h3 id="offline-functionality">Offline Functionality</h3>
<p>To make our app work offline, we will need something called a <a href="https://developers.google.com/web/fundamentals/primers/service-workers/">service worker</a>. A service worker is a script that runs in the background and provides functionality that does not require user interaction. Our service worker will cache our app so that it can be accessed offline.</p>
<p>In the <em>/src/webapp/</em> folder, make a JavaScript file called <code>sw</code> which will be short for ‘service worker’. Fill it out like this, remembering to change the app name around line 5 to whatever you named yours:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** SERVICE WORKER */</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span><span class="token function">skipWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'fishing_app'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
                <span class="token punctuation">[</span>
                    <span class="token string">'/'</span><span class="token punctuation">,</span>
                    <span class="token string">'/assets/bundle.js?compile=false'</span><span class="token punctuation">,</span>
                    <span class="token string">'/assets/favicon.ico'</span><span class="token punctuation">,</span>
                    <span class="token string">'/assets/bootstrap.css?compile=false'</span><span class="token punctuation">,</span>
                    <span class="token string">'/assets/bootstrap.js?compile=false'</span><span class="token punctuation">,</span>
                    <span class="token string">'/assets/jquery-2.2.0.min.js?compile=false'</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`error in caches: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Install event:'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// Cache falling back to the network</span>
<span class="token comment">// https://developers.google.com/web/ilt/pwa/caching-files-with-service-worker</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
        caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> response <span class="token operator">||</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The files being added to the cache cover our whole app. The first file <code>/</code> is our <em>index.gsp</em> in the views folder, which our React app is rendered on top of. The next line <code>bundle.js</code> contains all of our JavaScript. The rest of the files are other assets we need, Bootstrap for styling and JQuery.</p>
<p>In App.js, go back to the <code>componentWillMount()</code> function, and add the following code to the online check to register the service worker:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** checks for online &amp; logged in status */</span>
<span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// check if online</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>online<span class="token punctuation">:</span> navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">}</span><span class="token punctuation">)</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>online<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token comment">// check if a service worker is supported then register it</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./sw.js'</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Service worker registered."</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Service worker error:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        

        <span class="token comment">// check if logged in</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">"/user/getLogin"</span><span class="token punctuation">;</span>

        <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
            credentials<span class="token punctuation">:</span> <span class="token string">'same-origin'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>text <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">===</span> <span class="token string">'false'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>logged_in<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>logged_in<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We can test this by running the app again. When it loads, open the developer tools in your browser. The console should display this message:</p>
<p><img src="images/11.png" alt=""></p>
<p>Furthermore, click the network tab, and check the box that says Offline to turn off the internet connection.</p>
<p><img src="images/12.png" alt=""></p>
<p>Reload the page, and now, instead of getting the connection error page, we still get to see the app. The login/logout button should have also disappeared because we are offline. The network can be turned back on now.</p>
<p>One drawback to developing with a service worker that caches your app is that it will usually prefer to load the cached version of the app over the live version. If you restart the app and see none of the changes you made, open the developer tools in the browser. Navigate to the Application tab, and click on the left side bar option for ‘Clear storage’. Click the button that says ‘Clear site data’ and perform a hard reload of the page. Another workaround is using your browser’s incognito mode.</p>
<p><img src="images/13.png" alt=""></p>
<p>Now we can finally add functionality to make a new catch. This will be the rest of the app.<br>
We will create a button that opens up a modal containing the form to fill out the new Catch information. Submission of the form will save it in a queue to be uploaded to Grails when there is a stable internet connection. This queue will be represented as a table.</p>
<p>We will need to add two more state variables to start. In the constructor in App.js, add the following to the bottom of the state declaration:</p>
<pre class=" language-js"><code class="prism  language-js">showing_nc_modal<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token comment">// new catch modal</span>
queue<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                      <span class="token comment">// offline upload queue</span>
</code></pre>
<p>We then need to add these to the state shortcut in the render function</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>
    online<span class="token punctuation">,</span>
    logged_in<span class="token punctuation">,</span>

    posted_catches<span class="token punctuation">,</span>

    showing_detail_modal<span class="token punctuation">,</span>
    display_catch<span class="token punctuation">,</span>

    showing_loading_modal<span class="token punctuation">,</span>
    loading_message<span class="token punctuation">,</span>

    showing_nc_modal<span class="token punctuation">,</span>
    queue
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
</code></pre>
<p>Under this block, where we added the conditions for rendering the Catch table and the Catch detail modal, we need to add another condition for displaying the table for the Catch queue.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">// all items true if not empty</span>
<span class="token keyword">let</span> catches             <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>posted_catches<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// for posted catches</span>
<span class="token keyword">let</span> catch_to_display    <span class="token operator">=</span> <span class="token punctuation">(</span>display_catch <span class="token operator">!==</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token comment">// for catch detail modal</span>
<span class="token keyword">let</span> items_in_queue      <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span>             <span class="token comment">// for upload queue</span>
</code></pre>
<p>In the <code>return</code> statement, we are now going to add some more components. Below the Navbar, but above the Show Your Catches button in the render function, we are are going to add the queue, a button to submit the queue, and finally, a button for adding a new catch. Your <code>return</code> statement should look like this:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>AppNav
            logged_in<span class="token operator">=</span><span class="token punctuation">{</span>logged_in<span class="token punctuation">}</span>
            online<span class="token operator">=</span><span class="token punctuation">{</span>online<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>

        <span class="token punctuation">{</span> <span class="token comment">/* shows if there is a queue */</span>
            items_in_queue <span class="token operator">&amp;&amp;</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>UploadQueue queue<span class="token operator">=</span><span class="token punctuation">{</span>queue<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span> <span class="token comment">/* only upload if online &amp; logged in */</span>
            items_in_queue <span class="token operator">&amp;&amp;</span> online <span class="token operator">&amp;&amp;</span> logged_in <span class="token operator">&amp;&amp;</span>
            <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span>app_styles<span class="token punctuation">.</span>button<span class="token punctuation">}</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>uploadQueue<span class="token punctuation">}</span> bsStyle<span class="token operator">=</span><span class="token string">"success"</span><span class="token operator">&gt;</span>Submit Pending Catches<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span>app_styles<span class="token punctuation">.</span>button<span class="token punctuation">}</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>showNewCatchModal<span class="token punctuation">}</span> bsStyle<span class="token operator">=</span><span class="token string">"success"</span><span class="token operator">&gt;</span>New <span class="token class-name">Catch</span><span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>

        <span class="token punctuation">{</span> <span class="token comment">/* only show catches if online &amp; logged in */</span>
            online <span class="token operator">&amp;&amp;</span> logged_in <span class="token operator">&amp;&amp;</span>
            <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span>app_styles<span class="token punctuation">.</span>button<span class="token punctuation">}</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>showCatches<span class="token punctuation">}</span> bsStyle<span class="token operator">=</span><span class="token string">"success"</span><span class="token operator">&gt;</span>Show Your Catches<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span> <span class="token comment">/* only show if there have been catches posted */</span>
            catches <span class="token operator">&amp;&amp;</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>CatchTable
                    catches<span class="token operator">=</span><span class="token punctuation">{</span>posted_catches<span class="token punctuation">}</span>
                    showDetailModal<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>showDetailModal<span class="token punctuation">}</span>
                <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">{</span><span class="token comment">/* modals */</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>LoadingModal
            showing<span class="token operator">=</span><span class="token punctuation">{</span>showing_loading_modal<span class="token punctuation">}</span>
            hideModal<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>hideLoadingModal<span class="token punctuation">}</span>
            message<span class="token operator">=</span><span class="token punctuation">{</span>loading_message<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token punctuation">{</span>
            catch_to_display <span class="token operator">&amp;&amp;</span>
            <span class="token operator">&lt;</span>CatchDetailModal
                showing<span class="token operator">=</span><span class="token punctuation">{</span>showing_detail_modal<span class="token punctuation">}</span>
                hideModal<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>hideDetailModal<span class="token punctuation">}</span>
                selected_catch<span class="token operator">=</span><span class="token punctuation">{</span>display_catch<span class="token punctuation">}</span>
            <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>NewCatchModal
            showing<span class="token operator">=</span><span class="token punctuation">{</span>showing_nc_modal<span class="token punctuation">}</span>
            hideModal<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>hideNewCatchModal<span class="token punctuation">}</span>
            submitNewCatch<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>submitNewCatch<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>We conditionally render the upload queue so that it only appears if it is not empty. We are also conditionally rendering the Submit button, as we can only upload Catches if they exist, there is an internet connection, and there is a user logged in to associate them with. The new catch button gets rendered no matter what, because they get saved locally before being uploaded to Grails. Finally, add a New Catch modal under the other modals.</p>
<p>Next, we will add the components. We also will be making another util file to help us with the queue. In the <em>/webapp/components/</em> folder, make another JavaScript file called <code>UploadQueue</code>. In the <em>modals</em> folder, add another file called <code>NewCatchModal</code>. Finally, in the <em>/webapp/util/</em> folder, make another Javascript file called <code>Store</code>. Don’t forget to import them in App.js!</p>
<p>We are going to start with the upload queue. It is a lot simpler than the uploaded catches, because they will be listed by <code>tripName</code> only, but it is still built the same way.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Table <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-bootstrap'</span><span class="token punctuation">;</span>

<span class="token comment">/** shows the upload queue */</span>
<span class="token keyword">const</span> <span class="token function-variable function">UploadQueue</span> <span class="token operator">=</span> props <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> queue <span class="token punctuation">}</span> <span class="token operator">=</span> props

    <span class="token keyword">const</span> <span class="token function-variable function">table</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> rows <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">in</span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
                <span class="token operator">&lt;</span>tr key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token punctuation">{</span>queue<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>Table responsive<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>thead<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>tr<span class="token operator">&gt;</span><span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Catch Queue<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>thead<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>tbody<span class="token operator">&gt;</span>
                    <span class="token punctuation">{</span>rows<span class="token punctuation">}</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>tbody<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Table<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> UploadQueue<span class="token punctuation">;</span>
</code></pre>
<p>Next up is the new Catch modal.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Modal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-bootstrap'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> NewCatchForm <span class="token keyword">from</span> <span class="token string">'../NewCatchForm'</span>


<span class="token keyword">const</span> <span class="token function-variable function">NewCatchModal</span> <span class="token operator">=</span> props <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        showing<span class="token punctuation">,</span>
        hideModal<span class="token punctuation">,</span>
        submitNewCatch
    <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>Modal show<span class="token operator">=</span><span class="token punctuation">{</span>showing<span class="token punctuation">}</span> onHide<span class="token operator">=</span><span class="token punctuation">{</span>hideModal<span class="token punctuation">}</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Modal<span class="token punctuation">.</span>Header closeButton<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Modal<span class="token punctuation">.</span>Title<span class="token operator">&gt;</span>New <span class="token class-name">Catch</span><span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token punctuation">.</span>Title<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token punctuation">.</span>Header<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Modal<span class="token punctuation">.</span>Body<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>NewCatchForm
                    submitNewCatch<span class="token operator">=</span><span class="token punctuation">{</span>submitNewCatch<span class="token punctuation">}</span>
                <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token punctuation">.</span>Body<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Modal<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">export</span> <span class="token keyword">default</span> NewCatchModal<span class="token punctuation">;</span>

</code></pre>
<p>In the body of the Modal, we have our New Catch Form. This is another component that we will create. It is a form that takes the submitNewCatch prop that was passed to the modal, called upon submitting the form. In the <em>components</em> folder, make a new component called <strong>NewCatchForm</strong>.</p>
<p>The New Catch form component is going to be a little bit different. Unlike the other components, forms cannot be stateless. A form must keep an internal state so that it can send its data somewhere else. Read <a href="https://reactjs.org/docs/forms.html">this</a> doc for more information.</p>
<p>Start by filling out the component like this:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Button<span class="token punctuation">,</span> FormControl<span class="token punctuation">,</span> FormGroup<span class="token punctuation">,</span> ControlLabel<span class="token punctuation">,</span> ButtonToolbar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-bootstrap'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">NewCatchForm</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            tripName<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            fishType<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            dateCaught<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            xCoord<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            yCoord<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            comment<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            image<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>Because it has to have a state, it needs a constructor. The state variables are simply the fields to be filled out. Under the constructor, we are going to add a cool little function that autofills the user’s coordinates based on their location. We are again going to add a <code>componentWillMount()</code> function to do this.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** checks location for autofilling coordinates */</span>
<span class="token comment">// takes a minute</span>
<span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>navigator<span class="token punctuation">.</span>geolocation<span class="token punctuation">)</span>
        <span class="token keyword">return</span>

    navigator<span class="token punctuation">.</span>geolocation<span class="token punctuation">.</span><span class="token function">getCurrentPosition</span><span class="token punctuation">(</span>
        <span class="token comment">// success callback</span>
        position <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> latitude <span class="token operator">=</span> position<span class="token punctuation">.</span>coords<span class="token punctuation">.</span>latitude<span class="token punctuation">;</span>
            <span class="token keyword">const</span> longitude <span class="token operator">=</span> position<span class="token punctuation">.</span>coords<span class="token punctuation">.</span>longitude<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>latitude <span class="token operator">==</span> <span class="token keyword">null</span>
                <span class="token operator">||</span> longitude <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                xCoord<span class="token punctuation">:</span> latitude<span class="token punctuation">,</span>
                yCoord<span class="token punctuation">:</span> longitude
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token comment">// failure callback</span>
        error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"NewCatchForm - geolocate: "</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>While the form is being rendered, the window navigator tries to get the user’s coordinates. If it can, it sets the coordinate state variables to the these coordinates. If it cannot, it simply does nothing.</p>
<p>Next, we are going to add a function that validates the form data. If incorrect data (such as an alphabet character as one of the coordinates, or a blank tripName, fishType, or dateCaught) is sent to Grails, it will crash when it tries to save the data. To prevent this, we will perform validation at the top level. Add this under the <code>componentWillMount()</code> function.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** validates form */</span>
<span class="token function-variable function">valid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        tripName<span class="token punctuation">,</span>
        fishType<span class="token punctuation">,</span>
        dateCaught<span class="token punctuation">,</span>
        xCoord<span class="token punctuation">,</span>
        yCoord
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tripName <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Enter a trip name!'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fishType <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Enter a type of fish!'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dateCaught <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Enter a date!'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xCoord <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>xCoord<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> <span class="token punctuation">(</span>yCoord <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>yCoord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Coordinates must be numbers!'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Upon submission, this function gets called. If it returns false, the form is not submitted. Under this function, we will add the submit function.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** submits the form if valid */</span>
<span class="token function-variable function">handleSubmit</span> <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>

    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
        tripName<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>tripName<span class="token punctuation">,</span>
        fishType<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>fishType<span class="token punctuation">,</span>
        dateCaught<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>dateCaught<span class="token punctuation">,</span>
        xCoord<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>xCoord<span class="token punctuation">,</span>
        yCoord<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>yCoord<span class="token punctuation">,</span>
        comment<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>comment<span class="token punctuation">,</span>
        image<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>image
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">submitNewCatch</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The parameter <code>e</code> stands for event. Upon submission of a form, an event is fired. The first thing we need to do is call <code>preventDefault()</code> on the event. This is required, because the default HTML form behavior is browsing to a new page when the user submits the form. Instead, we want to ensure that the form data is valid, then compile the data into an object to pass to the <code>submitNewCatch</code> function.</p>
<p>In React, form fields have a function property called <code>onChange</code> which fires whenever the field is changed. We need to write a change handler to store the form data in its respective state variable. Under the <code>handleSubmit</code> function, add these two functions.</p>
<pre class=" language-js"><code class="prism  language-js"> <span class="token comment">/** form update handlers */</span>
<span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> target<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> target<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">:</span> value
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function-variable function">handleImg</span> <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
    <span class="token keyword">const</span> file <span class="token operator">=</span> target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        image<span class="token punctuation">:</span> file
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/* end update handlers */</span>
</code></pre>
<p>Again, they take an event as a parameter. The target property is the field being changed. The name of the target corresponds to the name property of the field, and the value is what was typed into the field. The <code>[name]</code> syntax puts the literal value in its place, rather than a string, so that we do not have to manually check which field is being updated. The <code>handleImg</code> function is similar, and is how we handle an image upload.</p>
<p>Finally, we can build the form and the rest of the component.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>form onSubmit<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleSubmit<span class="token punctuation">}</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>FormGroup controlId<span class="token operator">=</span><span class="token string">"formControlsTripName"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>ControlLabel<span class="token operator">&gt;</span>Trip Name<span class="token operator">&lt;</span><span class="token operator">/</span>ControlLabel<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>FormControl
                        type<span class="token operator">=</span><span class="token string">"text"</span>
                        placeholder<span class="token operator">=</span><span class="token string">"The name of your trip..."</span>
                        name<span class="token operator">=</span><span class="token string">"tripName"</span>
                        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span>
                    <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>FormGroup<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>FormGroup controlId<span class="token operator">=</span><span class="token string">"formControlsFishType"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>ControlLabel<span class="token operator">&gt;</span>Fish Type<span class="token operator">&lt;</span><span class="token operator">/</span>ControlLabel<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>FormControl
                        type<span class="token operator">=</span><span class="token string">"text"</span>
                        placeholder<span class="token operator">=</span><span class="token string">"The type of fish you caught..."</span>
                        name<span class="token operator">=</span><span class="token string">"fishType"</span>
                        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span>
                    <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>FormGroup<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>FormGroup controlId<span class="token operator">=</span><span class="token string">"formControlsDateCaught"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>ControlLabel<span class="token operator">&gt;</span>Date Caught<span class="token operator">&lt;</span><span class="token operator">/</span>ControlLabel<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>FormControl
                        type<span class="token operator">=</span><span class="token string">"date"</span>
                        placeholder<span class="token operator">=</span><span class="token string">"The type of fish you caught..."</span>
                        name<span class="token operator">=</span><span class="token string">"dateCaught"</span>
                        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span>
                    <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>FormGroup<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>FormGroup controlId<span class="token operator">=</span><span class="token string">"formControlsXCoord"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>ControlLabel<span class="token operator">&gt;</span>X<span class="token operator">-</span>Coordinate<span class="token operator">&lt;</span><span class="token operator">/</span>ControlLabel<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>FormControl
                        type<span class="token operator">=</span><span class="token string">"num"</span>
                        value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>xCoord<span class="token punctuation">}</span>
                        name<span class="token operator">=</span><span class="token string">"xCoord"</span>
                        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span>
                    <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>FormGroup<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>FormGroup controlId<span class="token operator">=</span><span class="token string">"formControlsYCoord"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>ControlLabel<span class="token operator">&gt;</span>Y<span class="token operator">-</span>Coordinate<span class="token operator">&lt;</span><span class="token operator">/</span>ControlLabel<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>FormControl
                        type<span class="token operator">=</span><span class="token string">"num"</span>
                        value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>yCoord<span class="token punctuation">}</span>
                        name<span class="token operator">=</span><span class="token string">"yCoord"</span>
                        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span>
                    <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>FormGroup<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>FormGroup controlId<span class="token operator">=</span><span class="token string">"formControlsComment"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>ControlLabel<span class="token operator">&gt;</span>Comment<span class="token operator">&lt;</span><span class="token operator">/</span>ControlLabel<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>FormControl
                        type<span class="token operator">=</span><span class="token string">"text"</span>
                        placeholder<span class="token operator">=</span><span class="token string">"Anything you would like to mention?"</span>
                        name<span class="token operator">=</span><span class="token string">"comment"</span>
                        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span>
                    <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>FormGroup<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>FormGroup controlId<span class="token operator">=</span><span class="token string">"formControlsImage"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>ControlLabel<span class="token operator">&gt;</span>Upload Image<span class="token operator">&lt;</span><span class="token operator">/</span>ControlLabel<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>FormControl
                        type<span class="token operator">=</span><span class="token string">"file"</span>
                        accept<span class="token operator">=</span><span class="token string">"image/*"</span>
                        name<span class="token operator">=</span><span class="token string">"image"</span>
                        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleImg<span class="token punctuation">}</span>
                        capture
                    <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>FormGroup<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>ButtonToolbar<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>Button id<span class="token operator">=</span><span class="token string">"submit-btn"</span> bsStyle<span class="token operator">=</span><span class="token string">"success"</span> type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">&gt;</span>Submit<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>ButtonToolbar<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> NewCatchForm<span class="token punctuation">;</span>
</code></pre>
<p>Now, we can build the Store util file, and put it all together. In the Store file, start by importing localforage and fetch.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">import</span> localforage <span class="token keyword">from</span> <span class="token string">'localforage'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'whatwg-fetch'</span><span class="token punctuation">;</span>
</code></pre>
<p>The first function we are going to write will store our submitted catch in localforage. We also are going to learn more about how to write Promises.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** function called in app to store catch data in localforage */</span>
<span class="token keyword">function</span> <span class="token function">storeCatch</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        localforage<span class="token punctuation">.</span><span class="token function">setDriver</span><span class="token punctuation">(</span>localforage<span class="token punctuation">.</span>INDEXEDDB<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// checks if an image was uploaded</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>image <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> imageUpload <span class="token operator">=</span> data<span class="token punctuation">.</span>image

                    <span class="token comment">// for converting image to blob string setup</span>
                    <span class="token keyword">let</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>imageUpload<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">const</span> photoID <span class="token operator">=</span> <span class="token function">generateGUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// generate id for the photo</span>
                    data<span class="token punctuation">.</span>image <span class="token operator">=</span> photoID<span class="token punctuation">;</span>           <span class="token comment">// put it in the dictionary</span>

                    <span class="token comment">// store actual image in localForage</span>
                    reader<span class="token punctuation">.</span><span class="token function-variable function">onloadend</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        localforage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>photoID<span class="token punctuation">,</span> reader<span class="token punctuation">.</span>result<span class="token punctuation">)</span>    <span class="token comment">// reader.result is the blob string</span>
                            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'localstorage - photo saved!'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// storing the catch data in localforage in a queue</span>
                <span class="token keyword">let</span> catches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

                <span class="token comment">// get the key first</span>
                localforage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'catches'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>q <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// queue</span>

                        <span class="token comment">// if there is anything in 'catches' we will push to it</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            catches <span class="token operator">=</span> q<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        catches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// clear localforage catches</span>
                        localforage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'catches'</span><span class="token punctuation">,</span> catches<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span>r<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tripName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// returns catch that was just stored</span>
                            <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>To write a Promise, we start by returning a new Promise. As previously mentioned, it has two callback functions, <code>resolve</code> and <code>reject</code>. They are both treated like <code>return</code> statements. If the operation inside the Promise is successful, <code>resolve</code> is called, and anything that is passed to it is accessible from the caller’s <code>.then</code> call. The same is true for <code>reject</code> and the caller’s <code>.catch</code> call.</p>
<p>Localforage’s full docs can be found <a href="https://localforage.github.io/localForage/">here</a>. To use localforage, the first thing we must do is set a driver for its datastore. We will be using <a href="https://developers.google.com/web/ilt/pwa/working-with-indexeddb">IndexedDB</a>. All the localforage operations must be done inside the resolved Promise.</p>
<p>To store the Catches, we first will generate a unique id for the image if one is attached. The id replaces the image in the Catch, and the Catch is stored in a queue in localforage. The image itself is converted to a blob string stored in another queue and its key is its id.</p>
<p>The first thing we do is check the Catch data for an image. If there is one, we generate a unique id using the following helper functions:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">// Use with generateGUID function to make random int</span>
<span class="token keyword">function</span> <span class="token function">genString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0x10000</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// For generating unique ID</span>
<span class="token keyword">function</span> <span class="token function">generateGUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token function">genString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token function">genString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token string">"-"</span>
        <span class="token operator">+</span> <span class="token function">genString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token string">"-4"</span>
        <span class="token operator">+</span> <span class="token function">genString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token string">"-"</span>
        <span class="token operator">+</span> <span class="token function">genString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token string">"-"</span>
        <span class="token operator">+</span> <span class="token function">genString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token function">genString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token function">genString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Then, we store the image in localforage. Next, we check localforage for the queue we will call <code>‘catches’</code>. If it exists, we add the Catch to it and put the queue back in localforage. If not, we make a new queue. After the catch is stored, we resolve the Promise, returning the tripName of the catch we just saved. The caller, which is App.js, will take this and add it to its queue state variable so the user can see it in the table. If there are any errors, we reject the Promise, passing the error back up.</p>
<p>Next, we need to write a function to submit the queue to Grails.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/**
 * function called in app to retrieve catch data from localforage
 *  &amp; post it to grails
 */</span>
<span class="token keyword">function</span> <span class="token function">submitQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        localforage<span class="token punctuation">.</span><span class="token function">setDriver</span><span class="token punctuation">(</span>localforage<span class="token punctuation">.</span>INDEXEDDB<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            localforage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'catches'</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>q <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span>

                    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> q<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                            <span class="token keyword">continue</span>

                        <span class="token function">submitHelper</span><span class="token punctuation">(</span>q<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// after all items in the queue are submitted, remove them</span>
                    localforage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'catches'</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Your catches have been uploaded successfully!'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We will write another Promise to achieve this. Again, we must set the driver for localforage before we can use it. This time, we get the queue from localforage. Then, one at a time to avoid race conditions, we pass each item to a helper function that uploads it to Grails. Finally, we remove the queue from localforage, as it is no longer needed. We resolve this Promise with a success message. Here is the helper function:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** submits one at a time */</span>
<span class="token keyword">function</span> <span class="token function">submitHelper</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">"/catch/newCatch"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> formDat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// if there is a photo</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>image <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This is getting the photo of the catch out of localforage</span>
        <span class="token comment">// it then makes a promise in which the fetch is called after</span>
        <span class="token comment">// it is full filled</span>
        localforage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>image<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// convert the blob string back to an appropriate file</span>
                <span class="token keyword">let</span> block <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> contentType <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> realData <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token function">b64toBlob</span><span class="token punctuation">(</span>realData<span class="token punctuation">,</span> contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>


                item<span class="token punctuation">.</span>image <span class="token operator">=</span> image

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        formDat<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
                    credentials<span class="token punctuation">:</span> <span class="token string">'same-origin'</span><span class="token punctuation">,</span>
                    body<span class="token punctuation">:</span> formDat
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span>  <span class="token punctuation">{</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Store.submit"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>

                localforage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                formDat<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
            credentials<span class="token punctuation">:</span> <span class="token string">'same-origin'</span><span class="token punctuation">,</span>
            body<span class="token punctuation">:</span> formDat
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span>  <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Store.submit"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The function checks the item for an image. If there is an image, it grabs it out of localforage, converts it from a blob string back into an image, and attaches it to the Catch. It then posts the Catch to the <code>newCatch</code> function in the Catch controller in Grails. Finally, it removes the image from localforage. If there is no image attached, it simply posts the Catch data to Grails. Here is the <code>b64toBlob</code> function that converts the image into an actual image from its blob string.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">// Converts blob string to a blob file</span>
<span class="token comment">// Taken from https://ourcodeworld.com/</span>
<span class="token keyword">function</span> <span class="token function">b64toBlob</span><span class="token punctuation">(</span>b64Data<span class="token punctuation">,</span> contentType<span class="token punctuation">,</span> sliceSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    contentType <span class="token operator">=</span> contentType <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
    sliceSize <span class="token operator">=</span> sliceSize <span class="token operator">||</span> <span class="token number">512</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> byteCharacters <span class="token operator">=</span> <span class="token function">atob</span><span class="token punctuation">(</span>b64Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> byteArrays <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> offset <span class="token operator">&lt;</span> byteCharacters<span class="token punctuation">.</span>length<span class="token punctuation">;</span> offset <span class="token operator">+=</span> sliceSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> slice <span class="token operator">=</span> byteCharacters<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> offset <span class="token operator">+</span> sliceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> byteNumbers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>slice<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> slice<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            byteNumbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> byteArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>byteNumbers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        byteArrays<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span>byteArrays<span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> contentType<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> blob<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Finally, we will write a Promise to get the queue from localforage and return it as an array of tripNames. This is going to be called when the app loads so that the user can close and open the app and still see all the Catches they made. We then will need to export the three Promises to use in App.js</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** gets current queue from localforage */</span>
<span class="token keyword">function</span> <span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        localforage<span class="token punctuation">.</span><span class="token function">setDriver</span><span class="token punctuation">(</span>localforage<span class="token punctuation">.</span>INDEXEDDB<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                localforage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'catches'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>q <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// queue</span>
                        <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">in</span> q<span class="token punctuation">)</span>
                            list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>q<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">.</span>tripName<span class="token punctuation">)</span>


                        <span class="token function">resolve</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> storeCatch<span class="token punctuation">,</span> getQueue<span class="token punctuation">,</span> submitQueue <span class="token punctuation">}</span>
</code></pre>
<p>Putting it all together, we will add the functions being called by the components. Under the rest of the show/hide modal functions, add a show and a hide function for the new Catch modal.</p>
<pre class=" language-js"><code class="prism  language-js"> <span class="token comment">/** opens the new catch modal */</span>
<span class="token function-variable function">showNewCatchModal</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        showing_nc_modal<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/** closes the new catch modal */</span>
<span class="token function-variable function">hideNewCatchModal</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        showing_nc_modal<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Next, the function to submit a new Catch from the form.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">/** stores the catch data in localforage */</span>
<span class="token function-variable function">submitNewCatch</span> <span class="token operator">=</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showLoadingModal</span><span class="token punctuation">(</span><span class="token string">'STORING CATCH IN QUEUE...'</span><span class="token punctuation">)</span>

    Store<span class="token punctuation">.</span><span class="token function">storeCatch</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>d <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>queue

            cache<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>queue<span class="token punctuation">:</span> cache<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"App.submitNewCatch"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hideLoadingModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hideNewCatchModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The function calls our Promise, and pushes the catch that was stored into the app’s queue.</p>
<p>Finally, we will write the function that uploads the queue.</p>
<pre class=" language-js"><code class="prism  language-js"> <span class="token comment">/** uploads the queue */</span>
<span class="token function-variable function">uploadQueue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showLoadingModal</span><span class="token punctuation">(</span><span class="token string">'UPLOADING CATCH QUEUE...'</span><span class="token punctuation">)</span>

    Store<span class="token punctuation">.</span><span class="token function">submitQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>queue<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token function">alert</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"App.uploadQueue"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hideLoadingModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code>submitQueue</code> promise resolves with a message, which gets passed to an alert.</p>
<p>One last thing before we’re done: we need to retrieve the queue when the app loads. Go back up to the <code>componentWillMount()</code> function and add this to the bottom:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showLoadingModal</span><span class="token punctuation">(</span><span class="token string">'LOADING UPLOAD QUEUE...'</span><span class="token punctuation">)</span>

<span class="token comment">// get upload queue</span>
Store<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>q <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>queue<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>queue<span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"App.cwm.Store.getQueuePromise"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hideLoadingModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>If there is a queue in localstorage, it gets put in the state to be added to the table.</p>
<p>Now, re-run the app. There should now be a New Catch button. Remember to flush the cache as mentioned earlier if there appear to be no changes.</p>
<p><img src="images/14.png" alt=""></p>
<p>Click on it, and our form appears.</p>
<p><img src="images/15.png" alt=""></p>
<p>Fill out the form, submit it, and the Catch queue appears. Logging in makes the queue submission button appear.</p>
<p><img src="images/16.png" alt=""></p>
<p>After submitting the queue, we must click the Show Your Catches button again to view all the catches that were posted.</p>
<p><img src="images/17.png" alt=""></p>
<p>Each catch in the table can be clicked to view its details.</p>
<p><img src="images/18.png" alt=""></p>
<p>That’s it! The app is complete. Hopefully this tutorial takes some of the confusion out of writing apps in React, as well as writing progressive web apps in general.</p>
</div>
</body>

</html>
